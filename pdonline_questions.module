<?php

function pdonline_questions_menu()
{
	$items = array();
	$items['questions'] = array
	(
		'title' => 'Questions',
		'description' => 'Answer all the questions',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('questions_form'),
		'access callback' => 'user_access',
		'access arguments' => array('access content'),
		'type' => MENU_NORMAL_ITEM
	);

	$items['report'] = array
	(
		//'title' => 'Questions',
		//'description' => 'Answer all the questions',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('questions_report'),
		'access callback' => 'user_access',
		'access arguments' => array('access content'),
		'type' => MENU_CALLBACK
	);
	return $items;
}

function questions_form($form, &$form_state)
{
	$oneN = rand(1,100);
	$twoN = rand(1,10);
	$threeN = rand(1,100);
	$fourN = rand(1,5);
	$fourC = chr(rand(97,122));
	$fiveN = rand(1,5);
	getOneYX($oneX, $oneY);
	$form = array();
	$form['divisible'] = array
	(
		'#type' => 'textfield',
		'#title' => '1) Is '.$oneN.' divisble by '.$oneX.' , '.$oneY.' , both or neither? <br/>
				<ul>			
					<li>If '.$oneX.' : Input "P"</li>
					<li>If '.$oneY.' : Input "D"</li>
					<li>If both: Input "PDOnline"</li>
					<li>If neither: Input '. $oneN .'</li>
				</ul>'
	);
	$form['oneN'] = array('#type' => 'hidden', '#value' => $oneN);
	$form['oneX'] = array('#type' => 'hidden', '#value' => $oneX);
	$form['oneY'] = array('#type' => 'hidden', '#value' => $oneY);

	$form['factorial'] = array
	(
		'#type' => 'textfield',
		'#title' => '2) What is '.$twoN.' factorial? '
	);
	$form['twoN'] = array('#type' => 'hidden', '#value' => $twoN);

	$form['bits'] = array
	(
		'#type' => 'textfield',
		'#title' => '3) How many bits are set in the binary conversion of '.$threeN
	);
	$form['threeN'] = array('#type' => 'hidden', '#value' => $threeN);

	$form['words'] = array
	(
		'#type' => 'textfield',
		'#title' => '4) Write '.$fourN.' words containing the character "'.$fourC.'"'
	);
	$form['fourN'] = array('#type' => 'hidden', '#value' => $fourN);
	$form['fourC'] = array('#type' => 'hidden', '#value' => 'l');

	$form['html'] = array
	(
		'#type' => 'textarea',
		'#title' => '5) Write some HTML with the word "PDOnline" nested '.$fiveN.' levels deep '
	);
	$form['fiveN'] = array('#type' => 'hidden', '#value' => $fiveN);


	$form['submit'] = array
	(
		'#type' => 'submit',
		'#value' => 'Submit'
	);

	$form['#submit'][]='questions_form_submit';

	return $form;
}

function questions_form_validate($form, &$form_state)
{
	if($form_state['values']['divisible'] == "")
	{
		form_set_error('divisible', 'Q1 is empty');
	}

	if($form_state['values']['factorial'] == "")
	{
		form_set_error('factorial', 'Q2 is empty');
	}

	if(!is_numeric($form_state['values']['factorial']))
	{
		form_set_error('factorial', 'Q2 answer can only be numeric');
	}

	if($form_state['values']['bits'] == "")
	{
		form_set_error('bits', 'Q3 is empty');
	}

	if(!is_numeric($form_state['values']['bits']))
	{
		form_set_error('bits', 'Q3 answer can only be numeric');
	}


	if($form_state['values']['words'] == "")
	{
		form_set_error('words', 'Q4 is empty');
	}

	if($form_state['values']['html'] == "")
	{
		form_set_error('html', 'Q5 is empty');
	}
}


function questions_form_submit($form, &$form_state)
{
		$oneResult = checkDivisible($form_state['values']['oneN'], $form_state['values']['oneX'], $form_state['values']['oneY'], $form_state['values']['divisible']);
		//drupal_set_message("1) " . $oneResult);
		$twoResult = checkFactorial($form_state['values']['twoN'], $form_state['values']['factorial']);
		//drupal_set_message("2) " . $twoResult);
		$threeResult = checkBits($form_state['values']['threeN'], $form_state['values']['bits']);
		//drupal_set_message("3) " . $threeResult);
		$fourResult = checkWords($form_state['values']['fourC'], $form_state['values']['words']);
		//drupal_set_message("4) " . $fourResult);
		$fiveResult = checkHtml($form_state['values']['fiveN'], $form_state['values']['html']);
		//drupal_set_message("4) " . $fiveResult);

		getScores($oneResult, $twoResult, $threeResult, $fourResult, $fiveResult, $totalScore, $percentageScore);
		//drupal_set_message($totalScore . " and " . $percentageScore);

		$con = mysqli_connect("localhost","lloyd4567","pdonline4567","questions");
		if(mysqli_connect_errno())
		{
			drupal_set_message("Failed to connect " . mysqli_connect_error);
		}
		$sql = mysqli_query($con, "INSERT INTO Results(id,questionOne,questionTwo,questionThree,questionFour,questionFive,totalScore,percentageScore)
							VALUES (0,'$oneResult','$twoResult','$threeResult','$fourResult','$fiveResult','$totalScore','$percentageScore')");
		mysqli_close($con);
		$form_state['redirect'] = 'report'; 							
}

function questions_report()
{
	$form = array();	
	$con = mysqli_connect("localhost","lloyd4567","pdonline4567","questions");
	if(mysqli_connect_errno())
	{
		drupal_set_message("Failed to connect " . mysqli_connect_error);
	}
	$results = mysqli_query($con, "SELECT *
    								FROM QuestionUsers, Results
    								WHERE QuestionUsers.resultID = Results.id AND QuestionUsers.id = 'lloyd4567';");
	while($row = mysqli_fetch_array($results))
	{
		$form['html'] = array
		(
			'#markup' =>
		"Name: " . $row['firstName'] . " " . $row['lastName'] . "<hr/>".
		"<table style='width:500px'>".
			"<th align='left'>Question</th>".
			"<th align='left'>Result</th>".
			"<tr>".
				"<td>1</td>".
				"<td>".$row['questionOne']."</td>".
			"</tr>".
			"<tr>".
				"<td>2</td>".
				"<td>".$row['questionTwo']."</td>".
			"</tr>".
			"<tr>".
				"<td>3</td>".
				"<td>".$row['questionThree']."</td>".
			"</tr>".
			"<tr>".
				"<td>4</td>".
				"<td>".$row['questionFour']."</td>".
			"</tr>".
			"<tr>".
				"<td>5</td>".
				"<td>".$row['questionFive']."</td>".
			"</tr>".
		"</table>".
		"<hr/> Total Score: " . $row['totalScore'] . "/5".
		"Percentage Score: " . $row['percentageScore'] . " %<br /><hr />"
		);

		$form['contents'] = array
		(
			'#type' => 'hidden', 
			'#value' => $row['firstName']." ".$row['lastName'].
					" 1 ".$row['questionOne'].
					" 2 ".$row['questionTwo'].
					" 3 ".$row['questionThree'].
					" 4 ".$row['questionFour'].
					" 5 ".$row['questionFive'].
					" tScore ".$row['totalScore'].
					" pScore ".$row['percentageScore']
					
	);
	}
	mysqli_close($con);

	$form['textFile'] = array
	(
		'#type' => 'textfield',
		'#title' => 'Enter fileName? '
	);

	$form['submit'] = array
	(
		'#type' => 'submit',
		'#value' => 'Submit'
	);

	$form['#submit'][]='questions_report_submit';
	return $form;
}

function questions_report_submit($form, &$form_state)
{
	$file = fopen($_SERVER['DOCUMENT_ROOT']."/".$form_state['values']['textFile'].'.txt',"w");
	fwrite($file, $form_state['values']['contents']);
	fclose($file);
	drupal_set_message('Saved');
}

function getOneYX(&$oneX, &$oneY)
{
	do
	{
		$oneX = rand(2,5);
		$oneY = rand(2,5);
	}while($oneX === $oneY);
}

function checkDivisible($oneN, $oneX, $oneY, $userAns)
{
	$result = 'Incorrect';
	if($oneN % $oneX == 0 && $oneN % $oneY == 0)
	{
		$ans = "PDOnline";
	}
	else if($oneN % $oneX == 0)
	{
		$ans = 'P';
	}
	else if($oneN % $oneX == 0)
	{
		$ans = 'D';
	}
	else
	{
		$ans = $oneN;
	}

	if($userAns == $ans)
	{
		$result = 'Correct';
	}
	return $result;
}

function checkFactorial($twoN, $userAns)
{
	$ans = 1;
	$result = "Incorrect";	
	for($i = 1; $i <= $twoN; $i++)
	{
		$ans = $ans * $i;
	}
	if($userAns == $ans)
	{
		$result = 'Correct';
	}
	return $result;
}

function checkBits($threeN, $userAns)
{
	$bitsEquivalent = decbin($threeN);
	$ans = strlen($bitsEquivalent);
	$result = "Incorrect";
	if($userAns == $ans)
	{
		$result = 'Correct';
	}
	return $result;
}

function checkWords($fourC, $userAns)
{
	$result = "Correct";
	$words = explode(" ", $userAns);
	foreach($words as $word)
	{
		if(strpos($word, $fourC) === false)
		{
			$result = "Incorrect";
		}
	}
	return $result;
}

function checkHtml($fiveN, $userAns)
{
	$result = "Incorrect";
	$combinedString = preg_replace("/\s+/","", $userAns);
	$word = strip_tags($combinedString);
	if($word == 'PDOnline')
	{
		$result = "Correct";
	}
	return $result;
}

function getScores($oneResult, $twoResult, $threeResult, $fourResult, $fiveResult, &$totalScore, &$percentageScore)
{
	$totalScore = 0;
	if($oneResult == 'Correct')
		$totalScore++;
	if($twoResult == 'Correct')
		$totalScore++;
	if($threeResult == 'Correct')
		$totalScore++;
	if($fourResult == 'Correct')
		$totalScore++;
	if($fiveResult == 'Correct')
		$totalScore++;
	$percentageScore = round(($totalScore/5) * 100);
}

